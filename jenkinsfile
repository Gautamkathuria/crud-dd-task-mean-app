pipeline {
    agent any

 tools {
        git 'Default'   
    }

    environment {
        FRONTEND_IMAGE = "kathuriagautam2411/mean-frontend"
        BACKEND_IMAGE  = "kathuriagautam2411/mean-backend"
        DEPLOY_SERVER  = "ubuntu@35.154.2.193"
        DOCKERHUB      = credentials('dockerhub-creds')
    }

    stages {
        stage('Checkout SCM') {
            steps {
                git branch: 'main', url: 'https://github.com/Gautamkathuria/crud-dd-task-mean-app.git',
                credentialsId: 'github-cred'
            }
        }

        stage('Build & Push Frontend on VM') {
            steps {
                sshagent(['vm-ssh-key']) {
                    sh """
                    ssh -o StrictHostKeyChecking=no $DEPLOY_SERVER '
                        rm -rf ~/mean-app || true &&
                        git clone https://github.com/Gautamkathuria/crud-dd-task-mean-app.git ~/mean-app &&
                        cd ~/mean-app/frontend &&
                        docker build -t $FRONTEND_IMAGE:\$BUILD_NUMBER . &&
                        echo $DOCKERHUB_PSW | docker login -u $DOCKERHUB_USR --password-stdin &&
                        docker push $FRONTEND_IMAGE:\$BUILD_NUMBER &&
                        docker tag $FRONTEND_IMAGE:\$BUILD_NUMBER $FRONTEND_IMAGE:latest &&
                        docker push $FRONTEND_IMAGE:latest
                    '
                    """
                }
            }
        }

        stage('Build & Push Backend on VM') {
            steps {
                sshagent(['vm-ssh-key']) {
                    sh """
                    ssh -o StrictHostKeyChecking=no $DEPLOY_SERVER '
                        cd ~/mean-app/backend &&
                        docker build -t $BACKEND_IMAGE:\$BUILD_NUMBER . &&
                        echo $DOCKERHUB_PSW | docker login -u $DOCKERHUB_USR --password-stdin &&
                        docker push $BACKEND_IMAGE:\$BUILD_NUMBER &&
                        docker tag $BACKEND_IMAGE:\$BUILD_NUMBER $BACKEND_IMAGE:latest &&
                        docker push $BACKEND_IMAGE:latest
                    '
                    """
                }
            }
        }

        stage('Deploy on VM') {
            steps {
                sshagent(['vm-ssh-key']) {
                    sh """
                    ssh -o StrictHostKeyChecking=no $DEPLOY_SERVER '
                        docker pull $FRONTEND_IMAGE:latest &&
                        docker pull $BACKEND_IMAGE:latest &&

                        docker stop mean-frontend || true &&
                        docker rm mean-frontend || true &&
                        docker run -d --name mean-frontend -p 80:80 $FRONTEND_IMAGE:latest &&

                        docker stop mean-backend || true &&
                        docker rm mean-backend || true &&
                        docker run -d --name mean-backend -p 5000:5000 $BACKEND_IMAGE:latest
                    '
                    """
                }
            }
        }
    }
}
